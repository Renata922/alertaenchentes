<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recuperar Senha — Alerta de Enchentes</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    body{background:linear-gradient(135deg,#025867 0%,#6b7fb6 100%);min-height:100vh}
    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:100%;max-width:440px;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:40px 32px;
      box-shadow:0 20px 40px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2);animation:slideUp .6s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    h1{font-size:28px;font-weight:700;color:#1a1a1a;margin-bottom:8px;text-align:center}
    .sub{color:#666;text-align:center;margin-bottom:32px;font-size:16px;line-height:1.5}
    form{display:grid;gap:20px}
    .input-group{display:flex;flex-direction:column;gap:6px}
    label{font-size:14px;font-weight:600;color:#374151;margin-left:4px}
    input{padding:14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;background:#fff;transition:all .3s ease;outline:none}
    input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1);transform:translateY(-1px)}
    input::placeholder{color:#9ca3af}
    button{padding:16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:12px;font-size:16px;
      font-weight:600;cursor:pointer;transition:all .3s ease;margin-top:8px}
    button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,.3)}
    button:active:not(:disabled){transform:translateY(0)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-voltar{background:#6b7280 !important;margin-top:16px}
    .btn-voltar:hover:not(:disabled){box-shadow:0 8px 20px rgba(107,114,128,.3)}
    .msg{padding:12px 16px;border-radius:8px;font-size:14px;font-weight:500;text-align:center;margin-top:8px}
    .msg.err{background:#fee2e2;color:#dc2626;border:1px solid #fecaca}
    .msg.ok{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #fff;border-radius:50%;border-top-color:transparent;
      animation:spin 1s ease-in-out infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:480px){.wrap{padding:32px 24px;margin:20px}h1{font-size:24px}input,button{padding:12px 14px}}
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <h1>Recuperar Senha</h1>
      <p class="sub">Digite seu e-mail para receber o código de recuperação</p>

      <!-- Etapa 1: E-mail -->
      <form id="formForgot" autocomplete="on">
        <div class="input-group">
          <label for="email">E-mail cadastrado</label>
          <input id="email" type="email" required placeholder="seu@email.com" autocomplete="email"/>
        </div>

        <button type="submit"><span id="btnEnviarText">Enviar código</span></button>
        <div id="msgForgot" class="msg" aria-live="polite"></div>

        <button type="button" class="btn-voltar" onclick="location.href='/login.html'">Voltar para o Login</button>
      </form>

      <!-- Etapa 2: Código + Nova senha -->
      <form id="formReset" style="display:none" autocomplete="off">
        <div class="input-group">
          <label for="code">Código de verificação</label>
          <input id="code" type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                 required placeholder="Digite o código de 6 dígitos" autocomplete="one-time-code"/>
        </div>

        <div class="input-group">
          <label for="novaSenha">Nova senha</label>
          <input id="novaSenha" type="password" required minlength="6" placeholder="Mínimo 6 caracteres" autocomplete="new-password"/>
        </div>

        <button type="submit"><span id="btnResetText">Redefinir senha</span></button>
        <div id="msgReset" class="msg" aria-live="polite"></div>

        <button type="button" class="btn-voltar" id="btnVoltarEtapa">Voltar</button>
      </form>
    </div>
  </div>

  <!-- VLibras -->
  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper><div class="vw-plugin-top-wrapper"></div></div>
  </div>
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script> new window.VLibras.Widget('https://vlibras.gov.br/app'); </script>

  <script>
    const formForgot    = document.getElementById('formForgot');
    const msgForgot     = document.getElementById('msgForgot');
    const formReset     = document.getElementById('formReset');
    const msgReset      = document.getElementById('msgReset');
    const btnEnviarText = document.getElementById('btnEnviarText');
    const btnResetText  = document.getElementById('btnResetText');
    const inputEmail    = document.getElementById('email');
    const inputCode     = document.getElementById('code');
    const btnVoltarEtapa= document.getElementById('btnVoltarEtapa');

    let emailGlobal = '';
    let sendingForgot = false;
    let sendingReset  = false;

    function setLoading(spanEl, loading, label){
      const btn = spanEl.closest('button');
      btn.disabled = loading;
      spanEl.innerHTML = loading ? '<div class="loading"></div>Processando...' : label;
    }

    function showMessage(el, text, type){
      el.textContent = text;
      el.className   = 'msg ' + (type || '');
    }

    function irParaEtapaReset(mensagemOk){
      formForgot.style.display = 'none';
      formReset.style.display  = 'grid';
      msgReset.textContent     = '';
      if (mensagemOk) showMessage(msgReset, mensagemOk, 'ok');
      inputCode.focus();
    }

    function voltarParaEmail(){
      formReset.style.display  = 'none';
      formForgot.style.display = 'grid';
      msgForgot.textContent    = '';
      inputEmail.focus();
    }
    btnVoltarEtapa.addEventListener('click', voltarParaEmail);

    // só números no código
    inputCode.addEventListener('input', () => {
      inputCode.value = inputCode.value.replace(/\D/g, '').slice(0, 6);
    });

    // Etapa 1: Solicitar código
    formForgot.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (sendingForgot) return;
      sendingForgot = true;

      msgForgot.textContent = '';

      const email = inputEmail.value.trim();
      if (!email){
        showMessage(msgForgot, 'Informe seu e-mail.', 'err');
        sendingForgot = false;
        return;
      }

      emailGlobal = email;
      setLoading(btnEnviarText, true, 'Enviar código');

      try{
        const r = await fetch('/auth/forgot', {
          method: 'POST',
          headers: {'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({ email })
        });

        // ignoramos o conteúdo por segurança (mesma resposta para e-mail existente ou não)
        const aviso = 'Se o e-mail existir em nossa base, você receberá um código em até 15 minutos. Verifique também a caixa de spam.';
        irParaEtapaReset(aviso);
      }catch(err){
        showMessage(msgForgot, 'Erro de rede. Tente novamente.', 'err');
      }finally{
        setLoading(btnEnviarText, false, 'Enviar código');
        sendingForgot = false;
      }
    });

    // Etapa 2: Redefinir senha
    formReset.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (sendingReset) return;
      sendingReset = true;

      msgReset.textContent = '';

      const payload = {
        email: emailGlobal,
        code: document.getElementById('code').value.trim(),
        novaSenha: document.getElementById('novaSenha').value
      };

      if (!payload.code || payload.code.length !== 6){
        showMessage(msgReset, 'Informe o código de 6 dígitos.', 'err');
        sendingReset = false;
        return;
      }
      if (!payload.novaSenha || payload.novaSenha.length < 6){
        showMessage(msgReset, 'A nova senha deve ter pelo menos 6 caracteres.', 'err');
        sendingReset = false;
        return;
      }

      setLoading(btnResetText, true, 'Redefinir senha');
      try{
        const r = await fetch('/auth/reset', {
          method: 'POST',
          headers: {'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload)
        });

        const ct = r.headers.get('content-type') || '';
        const data = ct.includes('application/json') ? await r.json() : { mensagem: await r.text() };

        if (r.ok && data?.sucesso){
          showMessage(msgReset, data.mensagem || 'Senha redefinida! Redirecionando...', 'ok');
          setTimeout(()=> location.href='/login.html', 1800);
        }else{
          showMessage(msgReset, data?.mensagem || 'Código inválido ou expirado.', 'err');
        }
      }catch{
        showMessage(msgReset, 'Erro de rede. Tente novamente.', 'err');
      }finally{
        setLoading(btnResetText, false, 'Redefinir senha');
        sendingReset = false;
      }
    });

    // micro animação de foco
    document.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('focus', ()=> inp.parentElement.style.transform='translateY(-2px)');
      inp.addEventListener('blur',  ()=> inp.parentElement.style.transform='translateY(0)');
    });
  </script>

  <script src="./reader.js" defer></script>
</body>
</html>
